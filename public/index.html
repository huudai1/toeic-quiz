<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TOEIC Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <audio id="audio" controls class="fixed top-4 right-4 z-50 hidden">
    <source id="audio-source" src="" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <div id="timer" class="fixed top-4 left-4 text-lg font-bold hidden"></div>
  <!-- Admin countdown controls -->
  <div id="countdown-toggle" class="fixed top-4 right-16 z-50 cursor-pointer hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </div>
  <div id="countdown-panel" class="fixed top-10 right-4 z-50 bg-white p-4 rounded-lg shadow-lg text-lg font-bold hidden transition-all duration-300 transform translate-y-[-10px]" style="white-space: pre-line;"></div>
  <div class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-3xl font-bold text-center mb-6">TOEIC Quiz</h1>

    <div id="welcome-screen" class="mb-6">
      <h2 class="text-xl font-bold mb-4">Chào mừng bạn đến với TOEIC Quiz!</h2>
      <p class="mb-4">Bạn là:</p>
      <button onclick="showAdminLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">Admin (Đăng nhập Google)</button>
      <button onclick="showStudentLogin()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Học sinh (Nhập tên)</button>
    </div>

    <div id="admin-login" class="mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Admin: Đăng nhập bằng Google</h2>
      <div id="g_id_onload"
           data-client_id="207656291282-cedkb5qkbeek0s9dbaca2o3ia3svjesv.apps.googleusercontent.com"
           data-callback="handleAdminCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div class="g_id_signin" data-type="standard"></div>
      <button onclick="showWelcomeScreen()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
    </div>

    <div id="student-login" class="mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Học sinh: Nhập tên của bạn</h2>
      <form id="student-name-form">
        <input type="text" id="student-name" class="w-full p-2 border rounded mb-4" placeholder="Nhập tên của bạn" required />
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Xác nhận</button>
        <button type="button" onclick="showWelcomeScreen()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </form>
    </div>

    <div id="room-code-screen" class="mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Học sinh: Nhập mã phòng thi</h2>
      <form id="room-code-form">
        <input type="text" id="room-code" class="w-full p-2 border rounded mb-4" placeholder="Nhập mã phòng (6 số)" required pattern="\d{6}" />
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Vào phòng</button>
        <button type="button" onclick="showStudentLogin()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </form>
    </div>

    <div id="quiz-list-screen" class="mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Danh sách đề thi</h2>
      <div id="quiz-status" class="text-lg font-semibold mb-4"></div>
      <div id="quiz-list" class="space-y-2"></div>
      <div id="admin-options" class="mt-4 hidden">
        <button onclick="createNewQuiz()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">Tạo đề mới</button>
        <button onclick="showUploadQuizzes()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">Nhập đề thi</button>
      </div>
      <button onclick="logout()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Đăng xuất</button>
    </div>

    <div id="room-screen" class="mb-6 hidden">
      <h2 class="text-xl font-bold mb-4">Phòng thi</h2>
      <div id="room-code-display" class="text-lg font-semibold mb-4"></div>
      <div id="participant-count" class="text-lg font-semibold mb-4"></div>
      <div class="flex space-x-4 mb-4">
        <input type="number" id="time-limit" class="p-2 border rounded" placeholder="Thời gian (phút, tối đa 120)" min="1" max="120" value="120" required />
        <button id="startBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Bắt đầu</button>
        <button id="endBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden">Kết thúc</button>
        <button id="interruptBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden">Kết thúc giữa chừng</button>
      </div>
      <div id="countdown-start" class="text-2xl font-bold mb-4 hidden"></div>
      <div id="results-stats" class="flex space-x-4 mb-4 hidden">
        <div class="bg-blue-100 p-4 rounded-lg flex-1 text-center">
          <h3 class="font-bold">Người cao nhất</h3>
          <p id="top-score"></p>
        </div>
        <div class="bg-blue-100 p-4 rounded-lg flex-1 text-center">
          <h3 class="font-bold">Người cao thứ hai</h3>
          <p id="second-score"></p>
        </div>
        <div class="bg-blue-100 p-4 rounded-lg flex-1 text-center">
          <h3 class="font-bold">Điểm trung bình</h3>
          <p id="average-score"></p>
        </div>
      </div>
      <h3 class="text-lg font-semibold mb-2">Danh sách học sinh</h3>
      <div id="participants-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      <button onclick="backToQuizList()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại danh sách đề</button>
    </div>

    <div id="upload-quizzes" class="mb-6 hidden">
      <h3 class="text-lg font-semibold mb-2">Nhập file đề thi (.json hoặc .zip)</h3>
      <input type="file" id="quizzes-file" accept=".json,.zip" class="mb-4">
      <button onclick="uploadQuizzes()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">Tải lên</button>
      <button onclick="backToQuizList()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
    </div>

    <div id="admin-step-audio" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 1: Đặt tên đề và tải file nghe (Part 1-4)</h3>
      <label class="block mb-2">Tên đề thi:</label>
      <input type="text" id="quiz-name" class="w-full p-2 border rounded mb-4" placeholder="Nhập tên đề thi (ví dụ: Đề thi TOEIC tháng 4)" required>
      <label class="block mb-2">File nghe Part 1 (6 câu):</label>
      <input type="file" id="audio-file-part1" accept="audio/mpeg" class="mb-4">
      <label class="block mb-2">File nghe Part 2 (25 câu):</label>
      <input type="file" id="audio-file-part2" accept="audio/mpeg" class="mb-4">
      <label class="block mb-2">File nghe Part 3 (39 câu):</label>
      <input type="file" id="audio-file-part3" accept="audio/mpeg" class="mb-4">
      <label class="block mb-2">File nghe Part 4 (30 câu):</label>
      <input type="file" id="audio-file-part4" accept="audio/mpeg" class="mb-4">
      <button onclick="nextAdminStep(1)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">Tiếp theo</button>
      <button onclick="backToQuizList()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
    </div>

    <div id="admin-step-part1" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 2: Part 1 (6 câu)</h3>
      <label class="block mb-2">Ảnh cho Part 1:</label>
      <input type="file" id="images-part1" multiple accept="image/*" class="mb-4">
      <label class="block mb-2">Đáp án đúng (A,D,C,B,...):</label>
      <textarea id="answer-key-part1" class="w-full p-2 border rounded mb-4" rows="3" placeholder="Nhập 6 đáp án, ví dụ: A,D,C,B,A,C"></textarea>
      <button onclick="prevAdminStep(1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mr-2">Quay lại</button>
      <button onclick="nextAdminStep(2)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
    </div>

    <div id="admin-step-part2" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 3: Part 2 (25 câu)</h3>
      <label class="block mb-2">Ảnh cho Part 2:</label>
      <input type="file" id="images-part2" multiple accept="image/*" class="mb-4">
      <label class="block mb-2">Đáp án đúng (A,D,C,B,...):</label>
      <textarea id="answer-key-part2" class="w-full p-2 border rounded mb-4" rows="3" placeholder="Nhập 25 đáp án, ví dụ: A,D,C,B,..."></textarea>
      <button onclick="prevAdminStep(2)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mr-2">Quay lại</button>
      <button onclick="nextAdminStep(3)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
    </div>

    <div id="admin-step-part3" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 4: Part 3 (39 câu)</h3>
      <label class="block mb-2">Ảnh cho Part 3:</label>
      <input type="file" id="images-part3" multiple accept="image/*" class="mb-4">
      <label class="block mb-2">Đáp án đúng (A,D,C,B,...):</label>
      <textarea id="answer-key-part3" class="w-full p-2 border rounded mb-4" rows="3" placeholder="Nhập 39 đáp án, ví dụ: A,D,C,B,..."></textarea>
      <button onclick="prevAdminStep(3)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mr-2">Quay lại</button>
      <button onclick="nextAdminStep(4)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
    </div>

    <div id="admin-step-part4" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 5: Part 4 (30 câu)</h3>
      <label class="block mb-2">Ảnh cho Part 4:</label>
      <input type="file" id="images-part4" multiple accept="image/*" class="mb-4">
      <label class="block mb-2">Đáp án đúng (A,D,C,B,...):</label>
      <textarea id="answer-key-part4" class="w-full p-2 border rounded mb-4" rows="3" placeholder="Nhập 30 đáp án, ví dụ: A,D,C,B,..."></textarea>
      <button onclick="prevAdminStep(4)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mr-2">Quay lại</button>
      <button onclick="nextAdminStep(5)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
    </div>

    <div id="admin-step-part5" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 6: Part 5 (30 câu)</h3>
      <label class="block mb-2">Ảnh cho Part 5:</label>
      <input type="file" id="images-part5" multiple accept="image/*" class="mb-4">
      <label class="block mb-2">Đáp án đúng (A,D,C,B,...):</label>
      <textarea id="answer-key-part5" class="w-full p-2 border rounded mb-4" rows="3" placeholder="Nhập 30 đáp án, ví dụ: A,D,C,B,..."></textarea>
      <button onclick="prevAdminStep(5)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mr-2">Quay lại</button>
      <button onclick="nextAdminStep(6)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
    </div>

    <div id="admin-step-part6" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 7: Part 6 (16 câu)</h3>
      <label class="block mb-2">Ảnh cho Part 6:</label>
      <input type="file" id="images-part6" multiple accept="image/*" class="mb-4">
      <label class="block mb-2">Đáp án đúng (A,D,C,B,...):</label>
      <textarea id="answer-key-part6" class="w-full p-2 border rounded mb-4" rows="3" placeholder="Nhập 16 đáp án, ví dụ: A,D,C,B,..."></textarea>
      <button onclick="prevAdminStep(6)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mr-2">Quay lại</button>
      <button onclick="nextAdminStep(7)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
    </div>

    <div id="admin-step-part7" class="admin-step hidden">
      <h3 class="text-lg font-semibold mb-2">Bước 8: Part 7 (54 câu)</h3>
      <label class="block mb-2">Ảnh cho Part 7:</label>
      <input type="file" id="images-part7" multiple accept="image/*" class="mb-4">
      <label class="block mb-2">Đáp án đúng (A,D,C,B,...):</label>
      <textarea id="answer-key-part7" class="w-full p-2 border rounded mb-4" rows="3" placeholder="Nhập 54 đáp án, ví dụ: A,D,C,B,..."></textarea>
      <button onclick="prevAdminStep(7)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mr-2">Quay lại</button>
      <button onclick="saveQuiz()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Lưu đề thi</button>
    </div>

    <div id="quiz-container" class="flex flex-col md:flex-row hidden">
      <div class="w-full md:w-1/2 pr-0 md:pr-4 overflow-y-auto max-h-screen">
        <h2 class="text-xl font-bold mb-4">Ảnh đề thi</h2>
        <div id="image-display" class="space-y-4"></div>
      </div>
      <div class="w-full md:w-1/2 pl-0 md:pl-4">
        <form id="quizForm">
          <div id="quiz-part1" class="quiz-part">
            <h2 class="text-xl font-bold">Part 1 (6 câu)</h2>
            <div id="section1" class="space-y-4"></div>
            <button type="button" onclick="nextQuizPart(1)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">Tiếp theo</button>
          </div>
          <div id="quiz-part2" class="quiz-part hidden">
            <h2 class="text-xl font-bold">Part 2 (25 câu)</h2>
            <div id="section2" class="space-y-4"></div>
            <button type="button" onclick="prevQuizPart(1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
            <button type="button" onclick="nextQuizPart(2)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">Tiếp theo</button>
          </div>
          <div id="quiz-part3" class="quiz-part hidden">
            <h2 class="text-xl font-bold">Part 3 (39 câu)</h2>
            <div id="section3" class="space-y-4"></div>
            <button type="button" onclick="prevQuizPart(2)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
            <button type="button" onclick="nextQuizPart(3)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">Tiếp theo</button>
          </div>
          <div id="quiz-part4" class="quiz-part hidden">
            <h2 class="text-xl font-bold">Part 4 (30 câu)</h2>
            <div id="section4" class="space-y-4"></div>
            <button type="button" onclick="prevQuizPart(3)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
            <button type="button" onclick="nextQuizPart(4)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">Tiếp theo</button>
          </div>
          <div id="quiz-part5" class="quiz-part hidden">
            <h2 class="text-xl font-bold">Part 5 (30 câu)</h2>
            <div id="section5" class="space-y-4"></div>
            <button type="button" onclick="prevQuizPart(4)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
            <button type="button" onclick="nextQuizPart(5)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">Tiếp theo</button>
          </div>
          <div id="quiz-part6" class="quiz-part hidden">
            <h2 class="text-xl font-bold">Part 6 (16 câu)</h2>
            <div id="section6" class="space-y-4"></div>
            <button type="button" onclick="prevQuizPart(5)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
            <button type="button" onclick="nextQuizPart(6)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">Tiếp theo</button>
          </div>
          <div id="quiz-part7" class="quiz-part hidden">
            <h2 class="text-xl font-bold">Part 7 (54 câu)</h2>
            <div id="section7" class="space-y-4"></div>
            <button type="button" onclick="prevQuizPart(6)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mt-4">Nộp bài</button>
          </div>
        </form>
      </div>
    </div>

    <div id="result-screen" class="hidden">
      <h2 class="text-xl font-bold mb-4">Chúc mừng bạn đã hoàn thành!</h2>
      <p id="result-score" class="text-lg"></p>
      <p id="result-time" class="text-lg"></p>
      <button onclick="logout()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Đăng xuất</button>
    </div>

    <div id="notification" class="mt-4 text-lg"></div>
  </div>

  <script>
    let user = null;
    let isAdmin = false;
    let timeLeft = 7200;
    let timerInterval = null;
    let isAdminControlled = false;
    let currentRoomCode = null;
    let participants = [];
    let currentQuizId = null;
    let socket = null;
    let currentAdminStep = 0;
    let currentQuizPart = 0;
    const partAnswerCounts = [6, 25, 39, 30, 30, 16, 54];

    // DOM elements
    const welcomeScreen = document.getElementById("welcome-screen");
    const adminLogin = document.getElementById("admin-login");
    const studentLogin = document.getElementById("student-login");
    const studentNameForm = document.getElementById("student-name-form");
    const roomCodeScreen = document.getElementById("room-code-screen");
    const roomCodeForm = document.getElementById("room-code-form");
    const quizListScreen = document.getElementById("quiz-list-screen");
    const roomScreen = document.getElementById("room-screen");
    const adminOptions = document.getElementById("admin-options");
    const uploadQuizzesSection = document.getElementById("upload-quizzes");
    const quizzesFileInput = document.getElementById("quizzes-file");
    const quizList = document.getElementById("quiz-list");
    const quizContainer = document.getElementById("quiz-container");
    const notification = document.getElementById("notification");
    const quizStatus = document.getElementById("quiz-status");
    const participantCount = document.getElementById("participant-count");
    const roomCodeDisplay = document.getElementById("room-code-display");
    const startBtn = document.getElementById("startBtn");
    const endBtn = document.getElementById("endBtn");
    const interruptBtn = document.getElementById("interruptBtn");
    const timeLimitInput = document.getElementById("time-limit");
    const countdownStart = document.getElementById("countdown-start");
    const resultsStats = document.getElementById("results-stats");
    const topScore = document.getElementById("top-score");
    const secondScore = document.getElementById("second-score");
    const averageScore = document.getElementById("average-score");
    const participantsList = document.getElementById("participants-list");
    const imageDisplay = document.getElementById("image-display");
    const audio = document.getElementById("audio");
    const audioSource = document.getElementById("audio-source");
    const timerDisplay = document.getElementById("timer");
    const quizForm = document.getElementById("quizForm");
    const resultScreen = document.getElementById("result-screen");
    const resultScore = document.getElementById("result-score");
    const resultTime = document.getElementById("result-time");
    const countdownToggle = document.getElementById("countdown-toggle");
    const countdownPanel = document.getElementById("countdown-panel");

    const wsProtocol = location.protocol === 'https:' ? 'wss://' : 'ws://';

    // Utility function to show notifications
    function showNotification(message, duration = 5000, error = false) {
      notification.innerText = message;
      notification.classList.toggle("text-red-500", error);
      setTimeout(() => {
        notification.innerText = "";
        notification.classList.remove("text-red-500");
      }, duration);
    }

    // Countdown logic for 6 days (admin only)
    let countdownInterval = null;
    let autoShowInterval = null;
    const sixDaysInSeconds = 6 * 24 * 60 * 60;
    let countdownTimeLeft = sixDaysInSeconds;

    function showCountdown() {
      countdownPanel.classList.remove("hidden");
      countdownPanel.classList.remove("translate-y-[-10px]");
      countdownPanel.classList.add("translate-y-0");
      setTimeout(hideCountdown, 5000);
    }

    function hideCountdown() {
      countdownPanel.classList.add("translate-y-[-10px]");
      setTimeout(() => {
        countdownPanel.classList.add("hidden");
        countdownPanel.classList.remove("translate-y-0");
      }, 300);
    }

    function startCountdown() {
      if (!isAdmin) return;
      countdownInterval = setInterval(() => {
        if (countdownTimeLeft <= 0) {
          clearInterval(countdownInterval);
          clearInterval(autoShowInterval);
          countdownPanel.innerText = "Hết thời gian dữ liệu có thể bị mất bất cứ lúc nào!";
          showCountdown();
          countdownToggle.classList.add("hidden");
          return;
        }
        const days = Math.floor(countdownTimeLeft / (24 * 60 * 60));
        const hours = Math.floor((countdownTimeLeft % (24 * 60 * 60)) / (60 * 60));
        const minutes = Math.floor((countdownTimeLeft % (60 * 60)) / 60);
        const seconds = countdownTimeLeft % 60;
        countdownPanel.innerText = `Thời gian còn lại: ${days} ngày ${hours}:${minutes < 10 ? "0" : ""}${minutes}:${seconds < 10 ? "0" : ""}${seconds}\nHãy nhớ tải đề về trước khi tắt!!!`;
        countdownTimeLeft--;
      }, 1000);

      autoShowInterval = setInterval(() => {
        if (!countdownPanel.classList.contains("hidden")) return;
        showCountdown();
      }, 30000);

      countdownToggle.addEventListener("click", () => {
        if (countdownPanel.classList.contains("hidden")) {
          showCountdown();
        } else {
          hideCountdown();
        }
      });

      showCountdown();
    }

    function generateRoomCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    function updateParticipantsList() {
      participantsList.innerHTML = "";
      participants.forEach(participant => {
        const div = document.createElement("div");
        div.className = `p-4 rounded-lg text-center ${participant.submitted ? 'bg-green-200' : 'bg-gray-100'} border`;
        div.innerText = participant.name;
        participantsList.appendChild(div);
      });
      participantCount.innerText = `Số người tham gia: ${participants.length}`;
      console.log("Updated participants:", participants);
      if (participants.length === 0 && isAdmin) {
        showNotification("Chưa có học sinh nào tham gia.", 5000);
      }
    }

    function showAdminLogin() {
      welcomeScreen.classList.add("hidden");
      adminLogin.classList.remove("hidden");
      studentLogin.classList.add("hidden");
      roomCodeScreen.classList.add("hidden");
      showNotification("", 0);
      countdownToggle.classList.add("hidden");
      countdownPanel.classList.add("hidden");
    }

    function showStudentLogin() {
      welcomeScreen.classList.add("hidden");
      adminLogin.classList.add("hidden");
      studentLogin.classList.remove("hidden");
      roomCodeScreen.classList.add("hidden");
      showNotification("", 0);
      countdownToggle.classList.add("hidden");
      countdownPanel.classList.add("hidden");
    }

    function showWelcomeScreen() {
      welcomeScreen.classList.remove("hidden");
      adminLogin.classList.add("hidden");
      studentLogin.classList.add("hidden");
      roomCodeScreen.classList.add("hidden");
      quizListScreen.classList.add("hidden");
      roomScreen.classList.add("hidden");
      quizContainer.classList.add("hidden");
      resultScreen.classList.add("hidden");
      document.querySelectorAll(".admin-step").forEach(step => step.classList.add("hidden"));
      uploadQuizzesSection.classList.add("hidden");
      showNotification("", 0);
      user = null;
      isAdmin = false;
      currentRoomCode = null;
      currentQuizId = null;
      participants = [];
      if (socket) {
        socket.close();
        socket = null;
      }
      countdownToggle.classList.toggle("hidden", !isAdmin);
      if (isAdmin) startCountdown();
    }

    function initializeWebSocket() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        console.log("WebSocket already open");
        return;
      }
      try {
        socket = new WebSocket(wsProtocol + location.host);
        socket.onopen = () => {
          console.log("WebSocket connected");
          if (isAdmin && currentRoomCode) {
            socket.send(JSON.stringify({ type: "createRoom", roomCode: currentRoomCode, quizId: currentQuizId }));
            console.log(`Sent createRoom: roomCode=${currentRoomCode}, quizId=${currentQuizId}`);
          } else if (!isAdmin && currentRoomCode) {
            socket.send(JSON.stringify({ type: "joinRoom", roomCode: currentRoomCode, username: user.name }));
            console.log(`Sent joinRoom: roomCode=${currentRoomCode}, username=${user.name}`);
          }
        };
        socket.onmessage = (event) => {
          console.log("WebSocket message:", event.data);
          handleWebSocketMessage(event);
        };
        socket.onerror = (error) => {
          console.error("WebSocket error:", error);
          showNotification("Lỗi kết nối WebSocket. Đang thử lại...", 5000, true);
        };
        socket.onclose = () => {
          console.log("WebSocket closed. Reconnecting...");
          socket = null;
          setTimeout(initializeWebSocket, 3000);
        };
      } catch (error) {
        console.error("WebSocket init failed:", error);
        showNotification("Không thể khởi tạo WebSocket.", 5000, true);
      }
    }

    window.handleAdminCredentialResponse = async (response) => {
      try {
        if (!response.credential) throw new Error("No credential received");
        const profile = JSON.parse(atob(response.credential.split('.')[1]));
        user = { name: profile.name, email: profile.email };
        isAdmin = true;
        adminLogin.classList.add("hidden");
        quizListScreen.classList.remove("hidden");
        adminOptions.classList.remove("hidden");
        initializeWebSocket();
        await loadQuizzes();
        countdownToggle.classList.remove("hidden");
        startCountdown();
      } catch (error) {
        console.error("Admin login error:", error);
        showNotification("Đăng nhập Admin thất bại.", 5000, true);
        showWelcomeScreen();
      }
    };

    studentNameForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        const name = document.getElementById("student-name").value.trim();
        if (!name) {
          showNotification("Vui lòng nhập tên!", 5000, true);
          return;
        }
        user = { name };
        isAdmin = false;
        studentLogin.classList.add("hidden");
        roomCodeScreen.classList.remove("hidden");
        countdownToggle.classList.add("hidden");
        countdownPanel.classList.add("hidden");
      } catch (error) {
        console.error("Student login error:", error);
        showNotification("Đăng nhập học sinh thất bại.", 5000, true);
      }
    };

    roomCodeForm.onsubmit = async (e) => {
      e.preventDefault();
      try {
        const roomCode = document.getElementById("room-code").value.trim();
        if (!roomCode.match(/^\d{6}$/)) {
          showNotification("Mã phòng phải là 6 số!", 5000, true);
          return;
        }
        currentRoomCode = roomCode;
        initializeWebSocket();
        roomCodeScreen.classList.add("hidden");
        showNotification("Đang chờ admin bắt đầu...");
      } catch (error) {
        console.error("Join room error:", error);
        showNotification("Không thể vào phòng. Kiểm tra mã phòng.", 5000, true);
      }
    };

    function backToQuizList() {
      quizListScreen.classList.remove("hidden");
      roomScreen.classList.add("hidden");
      uploadQuizzesSection.classList.add("hidden");
      document.querySelectorAll(".admin-step").forEach(step => step.classList.add("hidden"));
      quizContainer.classList.add("hidden");
      resultScreen.classList.add("hidden");
      showNotification("", 0);
      countdownToggle.classList.toggle("hidden", !isAdmin);
      if (isAdmin) startCountdown();
      loadQuizzes();
    }

    function createNewQuiz() {
      quizListScreen.classList.add("hidden");
      document.getElementById("admin-step-audio").classList.remove("hidden");
      countdownToggle.classList.add("hidden");
      countdownPanel.classList.add("hidden");
    }

    function showUploadQuizzes() {
      quizListScreen.classList.add("hidden");
      uploadQuizzesSection.classList.remove("hidden");
      countdownToggle.classList.add("hidden");
      countdownPanel.classList.add("hidden");
    }

    async function uploadQuizzes() {
      const file = quizzesFileInput.files[0];
      if (!file) {
        showNotification("Vui lòng chọn file!", 5000, true);
        return;
      }
      const formData = new FormData();
      formData.append("quizzes", file);
      try {
        const endpoint = file.name.endsWith('.zip') ? '/upload-quizzes-zip' : '/upload-quizzes';
        const res = await fetch(endpoint, { method: "POST", body: formData });
        const result = await res.json();
        showNotification(result.message);
        if (res.ok) backToQuizList();
        else throw new Error(result.message);
      } catch (error) {
        console.error("Upload error:", error);
        showNotification("Lỗi tải lên file.", 5000, true);
      }
    }

    async function downloadQuizzes(quizId) {
      try {
        const res = await fetch(`/download-quiz-zip/${quizId}`);
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `quiz_${quizId}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        showNotification("Đã tải file ZIP.");
      } catch (error) {
        console.error("Download error:", error);
        showNotification("Lỗi tải file ZIP.", 5000, true);
      }
    }

    async function loadQuizzes() {
      const url = isAdmin ? `/quizzes?email=${encodeURIComponent(user.email)}` : '/quizzes';
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
        const quizzes = await res.json();
        quizList.innerHTML = quizzes.length ? "" : "<p>Chưa có đề thi.</p>";
        quizzes.forEach(quiz => {
          const div = document.createElement("div");
          div.className = "flex items-center space-x-2";
          div.innerHTML = isAdmin ? `
            <span>${quiz.quizName}</span>
            <button onclick="createRoom('${quiz.quizId}')" class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Tạo phòng</button>
            <button onclick="downloadQuizzes('${quiz.quizId}')" class="bg-purple-500 text-white px-2 py-1 rounded hover:bg-purple-600">Tải xuống</button>
            <button onclick="deleteQuiz('${quiz.quizId}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Xóa</button>
          ` : `
            <span>${quiz.quizName}</span>
            <button onclick="startQuiz('${quiz.quizId}')" class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">Bắt đầu</button>
          `;
          quizList.appendChild(div);
        });
      } catch (error) {
        console.error("Load quizzes error:", error);
        showNotification("Không thể tải danh sách đề.", 5000, true);
        quizList.innerHTML = "<p>Lỗi tải danh sách.</p>";
      }
    }

    async function deleteQuiz(quizId) {
      if (!confirm("Bạn có chắc muốn xóa đề này?")) return;
      try {
        const res = await fetch(`/delete-quiz/${quizId}`, { method: "DELETE" });
        const result = await res.json();
        showNotification(result.message);
        if (res.ok) loadQuizzes();
      } catch (error) {
        console.error("Delete quiz error:", error);
        showNotification("Lỗi xóa đề.", 5000, true);
      }
    }

    async function createRoom(quizId) {
      try {
        currentQuizId = quizId;
        currentRoomCode = generateRoomCode();
        const res = await fetch("/select-quiz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quizId, roomCode: currentRoomCode }),
        });
        const result = await res.json();
        if (res.ok) {
          quizListScreen.classList.add("hidden");
          roomScreen.classList.remove("hidden");
          roomCodeDisplay.innerText = `Mã phòng: ${currentRoomCode}`;
          participantCount.innerText = "Số người tham gia: 0";
          participants = [];
          updateParticipantsList();
          countdownToggle.classList.add("hidden");
          countdownPanel.classList.add("hidden");
          initializeWebSocket();
        } else {
          showNotification(result.message, 5000, true);
        }
      } catch (error) {
        console.error("Create room error:", error);
        showNotification("Lỗi tạo phòng.", 5000, true);
      }
    }

    async function startQuiz(quizId) {
      try {
        if (!quizId) throw new Error("No quizId provided");
        currentQuizId = quizId;
        const res = await fetch("/select-quiz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quizId, roomCode: currentRoomCode }),
        });
        const result = await res.json();
        if (res.ok) {
          isAdminControlled = true;
          timeLeft = parseInt(timeLimitInput.value) * 60 || 7200;
          roomCodeScreen.classList.add("hidden");
          quizContainer.classList.remove("hidden");
          timerDisplay.classList.remove("hidden");
          audio.classList.remove("hidden");
          console.log("Quiz container shown for student");
          await loadAudio(1);
          await loadImages(1);
          startTimer();
          document.getElementById("quiz-part1").classList.remove("hidden");
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error("Start quiz error:", error);
        showNotification("Lỗi bắt đầu bài thi.", 5000, true);
        showRoomCodeScreen();
      }
    }

    async function loadAudio(part) {
      if (part > 4) {
        audio.classList.add("hidden");
        return;
      }
      try {
        const res = await fetch(`/quiz-audio?part=part${part}`);
        const data = await res.json();
        if (data.audio) {
          audioSource.src = data.audio;
          audio.load();
          console.log(`Audio loaded for Part ${part}`);
        } else {
          showNotification(`Không tìm thấy audio Part ${part}.`, 5000, true);
        }
      } catch (error) {
        console.error("Load audio error:", error);
        showNotification(`Lỗi tải audio Part ${part}.`, 5000, true);
      }
    }

    const createQuestion = (id, num, part) => {
      const div = document.createElement("div");
      div.className = "bg-gray-50 p-4 rounded border";
      div.innerHTML = `
        <label class="font-semibold">Câu ${num} (Part ${part})</label>
        <div class="mt-2 space-y-2">
          <label class="block"><input type="radio" name="${id}" value="A" class="mr-2"> A</label>
          <label class="block"><input type="radio" name="${id}" value="B" class="mr-2"> B</label>
          <label class="block"><input type="radio" name="${id}" value="C" class="mr-2"> C</label>
          <label class="block"><input type="radio" name="${id}" value="D" class="mr-2"> D</label>
        </div>
      `;
      return div;
    };

    const parts = [
      { id: "section1", count: 6, part: 1 },
      { id: "section2", count: 25, part: 2 },
      { id: "section3", count: 39, part: 3 },
      { id: "section4", count: 30, part: 4 },
      { id: "section5", count: 30, part: 5 },
      { id: "section6", count: 16, part: 6 },
      { id: "section7", count: 54, part: 7 },
    ];
    let questionIndex = 1;
    parts.forEach(({ id, count, part }) => {
      const section = document.getElementById(id);
      for (let i = 1; i <= count; i++) {
        section.appendChild(createQuestion(`q${questionIndex}`, questionIndex, part));
        questionIndex++;
      }
    });

    function startTimer() {
      timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          submitQuiz();
          return;
        }
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.innerText = `Thời gian còn lại: ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
        timeLeft--;
      }, 1000);
    }

    async function loadImages(part) {
      try {
        const res = await fetch(`/images?part=${part}`);
        const images = await res.json();
        imageDisplay.innerHTML = `<h3 class="text-lg font-semibold mb-2">Part ${part}</h3>`;
        images.forEach(url => {
          const img = document.createElement("img");
          img.src = url;
          img.className = "w-full max-w-xs mb-4 rounded";
          imageDisplay.appendChild(img);
        });
        console.log(`Images loaded for Part ${part}`);
      } catch (error) {
        console.error("Load images error:", error);
        showNotification(`Lỗi tải ảnh Part ${part}.`, 5000, true);
      }
    }

    function nextAdminStep(step) {
      if (step === 1) {
        const quizName = document.getElementById("quiz-name").value.trim();
        if (!quizName) {
          showNotification("Vui lòng nhập tên đề!", 5000, true);
          return;
        }
        const audioFiles = [
          document.getElementById("audio-file-part1").files[0],
          document.getElementById("audio-file-part2").files[0],
          document.getElementById("audio-file-part3").files[0],
          document.getElementById("audio-file-part4").files[0],
        ];
        if (audioFiles.some(file => !file)) {
          showNotification("Vui lòng tải tất cả file nghe!", 5000, true);
          return;
        }
        document.querySelectorAll(".admin-step").forEach(s => s.classList.add("hidden"));
        document.getElementById("admin-step-part1").classList.remove("hidden");
        currentAdminStep = step;
        return;
      }
      if (step >= 2 && step <= 7) {
        const part = step - 1;
        const imagesInput = document.getElementById(`images-part${part}`);
        if (!imagesInput.files.length) {
          showNotification(`Vui lòng tải ảnh Part ${part}!`, 5000, true);
          return;
        }
        const answerKey = document.getElementById(`answer-key-part${part}`).value.trim();
        if (!answerKey) {
          showNotification(`Vui lòng nhập đáp án Part ${part}!`, 5000, true);
          return;
        }
        const answers = answerKey.split(",").map(a => a.trim().toUpperCase());
        if (answers.length !== partAnswerCounts[part - 1] || !answers.every(a => ["A", "B", "C", "D"].includes(a))) {
          showNotification(`Đáp án Part ${part} không hợp lệ!`, 5000, true);
          return;
        }
      }
      document.querySelectorAll(".admin-step").forEach(s => s.classList.add("hidden"));
      document.getElementById(`admin-step-part${step}`).classList.remove("hidden");
      currentAdminStep = step;
    }

    function prevAdminStep(step) {
      document.querySelectorAll(".admin-step").forEach(s => s.classList.add("hidden"));
      document.getElementById(step === 1 ? "admin-step-audio" : `admin-step-part${step - 1}`).classList.remove("hidden");
      currentAdminStep = step - 1;
    }

    async function saveQuiz() {
      const quizName = document.getElementById("quiz-name").value.trim();
      if (!quizName) {
        showNotification("Vui lòng nhập tên đề!", 5000, true);
        return;
      }
      const formData = new FormData();
      const audioFiles = [
        document.getElementById("audio-file-part1").files[0],
        document.getElementById("audio-file-part2").files[0],
        document.getElementById("audio-file-part3").files[0],
        document.getElementById("audio-file-part4").files[0],
      ];
      audioFiles.forEach((file, i) => {
        if (file) formData.append(`audio-part${i + 1}`, file);
      });
      for (let i = 1; i <= 7; i++) {
        const files = document.getElementById(`images-part${i}`).files;
        for (let file of files) {
          formData.append(`images-part${i}`, file);
        }
      }
      const answerKey = {};
      let questionIndex = 1;
      for (let part = 1; part <= 7; part++) {
        const answerKeyInput = document.getElementById(`answer-key-part${part}`).value.trim();
        if (!answerKeyInput) {
          showNotification(`Vui lòng nhập đáp án Part ${part}!`, 5000, true);
          return;
        }
        const answers = answerKeyInput.split(",").map(a => a.trim().toUpperCase());
        if (answers.length !== partAnswerCounts[part - 1]) {
          showNotification(`Part ${part} cần ${partAnswerCounts[part - 1]} đáp án!`, 5000, true);
          return;
        }
        for (let i = 0; i < partAnswerCounts[part - 1]; i++) {
          answerKey[`q${questionIndex}`] = answers[i];
          questionIndex++;
        }
      }
      formData.append("answerKey", JSON.stringify(answerKey));
      formData.append("quizName", quizName);
      formData.append("createdBy", user.email);
      try {
        const res = await fetch("/save-quiz", { method: "POST", body: formData });
        const result = await res.json();
        showNotification(result.message);
        document.querySelectorAll(".admin-step").forEach(s => s.classList.add("hidden"));
        backToQuizList();
      } catch (error) {
        console.error("Save quiz error:", error);
        showNotification("Lỗi lưu đề.", 5000, true);
      }
    }

    function nextQuizPart(part) {
      document.querySelectorAll(".quiz-part").forEach(p => p.classList.add("hidden"));
      document.getElementById(`quiz-part${part + 1}`).classList.remove("hidden");
      loadImages(part + 1);
      loadAudio(part + 1);
      currentQuizPart = part + 1;
    }

    function prevQuizPart(part) {
      document.querySelectorAll(".quiz-part").forEach(p => p.classList.add("hidden"));
      document.getElementById(`quiz-part${part}`).classList.remove("hidden");
      loadImages(part);
      loadAudio(part);
      currentQuizPart = part;
    }

    function handleWebSocketMessage(event) {
      try {
        const msg = JSON.parse(event.data);
        console.log("WebSocket message received:", msg);
        switch (msg.type) {
          case "joinRoom":
            if (isAdmin) {
              participants = msg.participants?.map(name => ({ name, submitted: false })) || [];
              updateParticipantsList();
            }
            break;
          case "startCountdown":
            if (!isAdmin) {
              if (!msg.quizId) {
                showNotification("Lỗi: Không có quizId.", 5000, true);
                return;
              }
              currentQuizId = msg.quizId;
              countdownStart.classList.remove("hidden");
              let countdown = 3;
              countdownStart.innerText = `Bắt đầu trong ${countdown}...`;
              const interval = setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                  clearInterval(interval);
                  countdownStart.classList.add("hidden");
                  startQuiz(currentQuizId);
                } else {
                  countdownStart.innerText = `Bắt đầu trong ${countdown}...`;
                }
              }, 1000);
            }
            break;
          case "start":
            if (isAdmin) {
              startBtn.classList.add("hidden");
              endBtn.classList.remove("hidden");
              interruptBtn.classList.remove("hidden");
            }
            break;
          case "end":
          case "interrupt":
            if (!isAdmin) {
              submitQuiz();
            } else {
              endBtn.classList.add("hidden");
              interruptBtn.classList.add("hidden");
              fetchResults();
            }
            break;
          case "submitted":
            if (isAdmin) {
              const participant = participants.find(p => p.name === msg.username);
              if (participant) {
                participant.submitted = true;
                updateParticipantsList();
              }
              showNotification(`${msg.username} đã nộp bài.`);
            }
            break;
          case "results":
            if (isAdmin) {
              resultsStats.classList.remove("hidden");
              topScore.innerText = msg.top ? `${msg.top.username}: ${msg.top.score}/200` : "Chưa có";
              secondScore.innerText = msg.second ? `${msg.second.username}: ${msg.second.score}/200` : "Chưa có";
              averageScore.innerText = msg.average ? `${msg.average.toFixed(2)}/200` : "Chưa có";
              participants = msg.results.map(result => ({
                name: result.username,
                submitted: true,
                score: result.score
              }));
              updateParticipantsList();
            }
            break;
          case "error":
            if (!isAdmin && msg.message === "Invalid room code") {
              showNotification("Mã phòng không tồn tại!", 5000, true);
              showRoomCodeScreen();
            }
            break;
        }
      } catch (error) {
        console.error("WebSocket message error:", error);
        showNotification("Lỗi xử lý thông điệp.", 5000, true);
      }
    }

    function showRoomCodeScreen() {
      roomCodeScreen.classList.remove("hidden");
      quizContainer.classList.add("hidden");
      showNotification("", 0);
    }

    startBtn.onclick = () => {
      if (participants.length === 0) {
        showNotification("Chưa có học sinh tham gia!", 5000, true);
        return;
      }
      const timeLimit = parseInt(timeLimitInput.value) * 60;
      if (isNaN(timeLimit) || timeLimit <= 0 || timeLimit > 7200) {
        showNotification("Thời gian không hợp lệ! Mặc định 120 phút.", 5000, true);
        timeLimitInput.value = .xr;
        return;
      }
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: "startCountdown", timeLimit, quizId: currentQuizId }));
        console.log(`Sent startCountdown: timeLimit=${timeLimit}, quizId=${currentQuizId}`);
        countdownStart.classList.remove("hidden");
        let countdown = 3;
        countdownStart.innerText = `Bắt đầu trong ${countdown}...`;
        const interval = setInterval(() => {
          countdown--;
          if (countdown <= 0) {
            clearInterval(interval);
            countdownStart.classList.add("hidden");
            socket.send(JSON.stringify({ type: "start", timeLimit }));
            console.log(`Sent start: timeLimit=${timeLimit}`);
          } else {
            countdownStart.innerText = `Bắt đầu trong ${countdown}...`;
          }
        }, 1000);
      } else {
        showNotification("Lỗi kết nối WebSocket.", 5000, true);
      }
    };

    endBtn.onclick = () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: "end" }));
        console.log("Sent end message");
      } else {
        showNotification("Lỗi kết nối WebSocket.", 5000, true);
      }
    };

    interruptBtn.onclick = () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ type: "interrupt" }));
        console.log("Sent interrupt message");
      } else {
        showNotification("Lỗi kết nối WebSocket.", 5000, true);
      }
    };

    async function fetchResults() {
      try {
        const res = await fetch("/results");
        const results = await res.json();
        if (isAdmin) {
          const sortedResults = results.sort((a, b) => b.score - a.score);
          const top = sortedResults[0];
          const second = sortedResults[1];
          const average = results.length > 0 ? results.reduce((sum, r) => sum + r.score, 0) / results.length : 0;
          socket.send(JSON.stringify({
            type: "results",
            results,
            top,
            second,
            average
          }));
          console.log("Sent results:", { results, top, second, average });
        }
      } catch (error) {
        console.error("Fetch results error:", error);
        showNotification("Lỗi tải kết quả.", 5000, true);
      }
    }

    async function submitQuiz() {
      const formData = new FormData(quizForm);
      const answers = {};
      formData.forEach((val, key) => answers[key] = val);
      try {
        const res = await fetch("/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: user.name, answers, roomCode: currentRoomCode }),
        });
        const result = await res.json();
        if (res.ok) {
          quizContainer.classList.add("hidden");
          resultScreen.classList.remove("hidden");
          timerDisplay.classList.add("hidden");
          audio.classList.add("hidden");
          resultScore.innerText = `Điểm: ${result.score}/200`;
          resultTime.innerText = `Thời gian nộp: ${new Date().toLocaleString()}`;
          quizForm.querySelector("button[type=submit]").disabled = true;
          clearInterval(timerInterval);
          if (isAdminControlled && socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ type: "submitted", username: user.name }));
            console.log(`Sent submitted: username=${user.name}`);
          }
        } else {
          showNotification(result.message || "Lỗi nộp bài!", 5000, true);
        }
      } catch (error) {
        console.error("Submit quiz error:", error);
        showNotification("Lỗi nộp bài.", 5000, true);
      }
    }

    quizForm.onsubmit = async (e) => {
      e.preventDefault();
      await submitQuiz();
    };

    function logout() {
      showWelcomeScreen();
    }
  </script>
</body>
</html>