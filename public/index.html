<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google-signin-client_id" content="207656291282-cedkb5qkbeek0s9dbaca2o3ia3svjesv.apps.googleusercontent.com">
  <title>Quiz App</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Màn hình chào mừng -->
  <div id="welcome-screen" class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">Quiz App</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <button onclick="showAdminLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Đăng nhập Admin</button>
      <button onclick="showStudentLogin()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Đăng nhập Học sinh</button>
    </div>
  </div>

  <!-- Màn hình đăng nhập Admin -->
  <div id="admin-login" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Đăng nhập Admin</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div id="g_id_onload"
         data-client_id="207656291282-cedkb5qkbeek0s9dbaca2o3ia3svjesv.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <button onclick="showWelcomeScreen()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
  </div>

  <!-- Màn hình đăng nhập Học sinh -->
  <div id="student-login" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Đăng nhập Học sinh</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <form id="student-name-form" class="space-y-4">
      <div>
        <label for="student-name" class="block text-lg">Tên học sinh:</label>
        <input id="student-name" type="text" class="border p-2 rounded w-full" required>
      </div>
      <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Xác nhận</button>
      <button type="button" onclick="showWelcomeScreen()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
    </form>
  </div>

  <!-- Màn hình danh sách đề thi -->
  <div id="quiz-list-screen" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Danh sách đề thi</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div id="quiz-list" class="space-y-4"></div>
    <button onclick="showWelcomeScreen()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Đăng xuất</button>
  </div>

  <!-- Màn hình tùy chọn Admin -->
  <div id="admin-options" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Tùy chọn Admin</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <button onclick="showQuizList()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Quản lý đề thi</button>
      <button onclick="showUploadQuizzes()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tạo đề thi mới</button>
      <button onclick="showHistory()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Lịch sử thi</button>
      <button onclick="showDirectTestScreen()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tổ chức thi trực tiếp</button>
      <button onclick="showWelcomeScreen()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Đăng xuất</button>
    </div>
  </div>

  <!-- Màn hình điều khiển thi Admin -->
  <div id="admin-controls" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Điều khiển thi</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <p id="quiz-status" class="text-lg mb-4"></p>
    <p id="participant-count" class="text-lg mb-4"></p>
    <p id="submitted-count" class="text-lg mb-4"></p>
    <div class="space-y-4">
      <button id="assignBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Bắt đầu thi</button>
      <button onclick="backToQuizList()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
    </div>
    <h2 class="text-2xl font-bold mt-4">Kết quả</h2>
    <table id="results-table" class="w-full border-collapse">
      <thead>
        <tr>
          <th class="border p-2">Tên</th>
          <th class="border p-2">Điểm</th>
          <th class="border p-2">Thời gian</th>
        </tr>
      </thead>
      <tbody id="results-body"></tbody>
    </table>
  </div>

  <!-- Màn hình tải đề thi -->
  <div id="upload-quizzes" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <button onclick="showAdminStep(1)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Bắt đầu tạo đề</button>
      <button onclick="backToQuizList()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
    </div>
  </div>

  <!-- Màn hình lịch sử thi -->
  <div id="history-screen" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Lịch sử thi</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <table id="history-table" class="w-full border-collapse">
      <thead>
        <tr>
          <th class="border p-2">Tên đề</th>
          <th class="border p-2">Tên học sinh</th>
          <th class="border p-2">Điểm</th>
          <th class="border p-2">Thời gian</th>
        </tr>
      </thead>
      <tbody id="history-body"></tbody>
    </table>
    <button onclick="backToQuizList()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 mt-4">Quay lại</button>
  </div>

  <!-- Màn hình thi trực tiếp -->
  <div id="direct-test-screen" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Tổ chức thi trực tiếp</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <p id="direct-participant-count" class="text-lg mb-4"></p>
    <p id="direct-submitted-count" class="text-lg mb-4"></p>
    <div class="space-y-4">
      <button id="directTestBtn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Bắt đầu thi</button>
      <button id="endDirectTestBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden">Kết thúc thi</button>
      <button onclick="backToQuizList()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
    </div>
    <h2 class="text-2xl font-bold mt-4">Kết quả</h2>
    <table id="direct-results-table" class="w-full border-collapse">
      <thead>
        <tr>
          <th class="border p-2">Tên</th>
          <th class="border p-2">Điểm</th>
          <th class="border p-2">Thời gian</th>
        </tr>
      </thead>
      <tbody id="direct-results-body"></tbody>
    </table>
  </div>

  <!-- Giao diện tạo đề thi -->
  <div id="admin-step-audio" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 1: Tên và file nghe</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="quiz-name" class="block text-lg font-medium">Tên đề thi:</label>
        <input id="quiz-name" type="text" class="border p-2 rounded w-full" placeholder="Nhập tên đề thi (tối đa 100 ký tự)" required>
      </div>
      <div>
        <label for="audio-file-part1" class="block text-lg font-medium">File nghe Part 1:</label>
        <input id="audio-file-part1" type="file" accept="audio/*" class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="audio-file-part2" class="block text-lg font-medium">File nghe Part 2:</label>
        <input id="audio-file-part2" type="file" accept="audio/*" class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="audio-file-part3" class="block text-lg font-medium">File nghe Part 3:</label>
        <input id="audio-file-part3" type="file" accept="audio/*" class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="audio-file-part4" class="block text-lg font-medium">File nghe Part 4:</label>
        <input id="audio-file-part4" type="file" accept="audio/*" class="border p-2 rounded w-full">
      </div>
      <div class="flex space-x-4">
        <button onclick="nextAdminStep(1)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
        <button onclick="backToQuizList()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <div id="admin-step-part1" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 2: Part 1</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="images-part1" class="block text-lg font-medium">Ảnh Part 1:</label>
        <input id="images-part1" type="file" accept="image/*" multiple class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="answer-key-part1" class="block text-lg font-medium">Đáp án Part 1 (6 đáp án, cách nhau bằng dấu phẩy):</label>
        <input id="answer-key-part1" type="text" oninput="displayAnswerCount(1)" class="border p-2 rounded w-full" placeholder="A,B,C,D,A,B">
        <p id="answer-count-part1" class="text-sm text-gray-600 mt-1">Đã nhập: 0/6 đáp án</p>
      </div>
      <div class="flex space-x-4">
        <button onclick="nextAdminStep(2)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
        <button onclick="prevAdminStep(1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <div id="admin-step-part2" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 3: Part 2</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="images-part2" class="block text-lg font-medium">Ảnh Part 2:</label>
        <input id="images-part2" type="file" accept="image/*" multiple class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="answer-key-part2" class="block text-lg font-medium">Đáp án Part 2 (25 đáp án, cách nhau bằng dấu phẩy):</label>
        <input id="answer-key-part2" type="text" oninput="displayAnswerCount(2)" class="border p-2 rounded w-full" placeholder="A,B,C,...">
        <p id="answer-count-part2" class="text-sm text-gray-600 mt-1">Đã nhập: 0/25 đáp án</p>
      </div>
      <div class="flex space-x-4">
        <button onclick="nextAdminStep(3)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
        <button onclick="prevAdminStep(2)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <div id="admin-step-part3" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 4: Part 3</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="images-part3" class="block text-lg font-medium">Ảnh Part 3:</label>
        <input id="images-part3" type="file" accept="image/*" multiple class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="answer-key-part3" class="block text-lg font-medium">Đáp án Part 3 (39 đáp án, cách nhau bằng dấu phẩy):</label>
        <input id="answer-key-part3" type="text" oninput="displayAnswerCount(3)" class="border p-2 rounded w-full" placeholder="A,B,C,...">
        <p id="answer-count-part3" class="text-sm text-gray-600 mt-1">Đã nhập: 0/39 đáp án</p>
      </div>
      <div class="flex space-x-4">
        <button onclick="nextAdminStep(4)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
        <button onclick="prevAdminStep(3)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <div id="admin-step-part4" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 5: Part 4</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="images-part4" class="block text-lg font-medium">Ảnh Part 4:</label>
        <input id="images-part4" type="file" accept="image/*" multiple class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="answer-key-part4" class="block text-lg font-medium">Đáp án Part 4 (30 đáp án, cách nhau bằng dấu phẩy):</label>
        <input id="answer-key-part4" type="text" oninput="displayAnswerCount(4)" class="border p-2 rounded w-full" placeholder="A,B,C,...">
        <p id="answer-count-part4" class="text-sm text-gray-600 mt-1">Đã nhập: 0/30 đáp án</p>
      </div>
      <div class="flex space-x-4">
        <button onclick="nextAdminStep(5)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
        <button onclick="prevAdminStep(4)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <div id="admin-step-part5" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 6: Part 5</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="images-part5" class="block text-lg font-medium">Ảnh Part 5:</label>
        <input id="images-part5" type="file" accept="image/*" multiple class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="answer-key-part5" class="block text-lg font-medium">Đáp án Part 5 (30 đáp án, cách nhau bằng dấu phẩy):</label>
        <input id="answer-key-part5" type="text" oninput="displayAnswerCount(5)" class="border p-2 rounded w-full" placeholder="A,B,C,...">
        <p id="answer-count-part5" class="text-sm text-gray-600 mt-1">Đã nhập: 0/30 đáp án</p>
      </div>
      <div class="flex space-x-4">
        <button onclick="nextAdminStep(6)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
        <button onclick="prevAdminStep(5)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <div id="admin-step-part6" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 7: Part 6</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="images-part6" class="block text-lg font-medium">Ảnh Part 6:</label>
        <input id="images-part6" type="file" accept="image/*" multiple class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="answer-key-part6" class="block text-lg font-medium">Đáp án Part 6 (16 đáp án, cách nhau bằng dấu phẩy):</label>
        <input id="answer-key-part6" type="text" oninput="displayAnswerCount(6)" class="border p-2 rounded w-full" placeholder="A,B,C,...">
        <p id="answer-count-part6" class="text-sm text-gray-600 mt-1">Đã nhập: 0/16 đáp án</p>
      </div>
      <div class="flex space-x-4">
        <button onclick="nextAdminStep(7)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tiếp theo</button>
        <button onclick="prevAdminStep(6)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <div id="admin-step-part7" class="container mx-auto p-4 hidden admin-step">
    <h1 class="text-3xl font-bold mb-4">Tạo đề thi mới - Bước 8: Part 7</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <div class="space-y-4">
      <div>
        <label for="images-part7" class="block text-lg font-medium">Ảnh Part 7:</label>
        <input id="images-part7" type="file" accept="image/*" multiple class="border p-2 rounded w-full">
      </div>
      <div>
        <label for="answer-key-part7" class="block text-lg font-medium">Đáp án Part 7 (54 đáp án, cách nhau bằng dấu phẩy):</label>
        <input id="answer-key-part7" type="text" oninput="displayAnswerCount(7)" class="border p-2 rounded w-full" placeholder="A,B,C,...">
        <p id="answer-count-part7" class="text-sm text-gray-600 mt-1">Đã nhập: 0/54 đáp án</p>
      </div>
      <div class="flex space-x-4">
        <button onclick="saveQuiz()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Lưu đề thi</button>
        <button onclick="prevAdminStep(7)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
      </div>
    </div>
  </div>

  <!-- Giao diện thi -->
  <div id="quiz-container" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Bài thi</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <p id="timer" class="text-lg mb-4 hidden"></p>
    <audio id="audio" controls class="mb-4 hidden">
      <source id="audio-source" src="" type="audio/mpeg">
    </audio>
    <div class="flex flex-col md:flex-row h-[calc(100vh-200px)] gap-4">
      <div id="image-list" class="w-full md:w-1/2 bg-white p-4 rounded-lg shadow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">Ảnh Part <span id="image-part-number"></span></h3>
        <div id="image-content" class="space-y-4"></div>
      </div>
      <div id="question-list" class="w-full md:w-1/2 bg-white p-4 rounded-lg shadow overflow-y-auto">
        <h3 class="text-lg font-semibold mb-2">Câu hỏi Part <span id="question-part-number"></span></h3>
        <form id="quizForm" class="space-y-4">
          <div id="quiz-part1" class="part-section">
            <div id="section1" class="space-y-4"></div>
          </div>
          <div id="quiz-part2" class="part-section hidden">
            <div id="section2" class="space-y-4"></div>
          </div>
          <div id="quiz-part3" class="part-section hidden">
            <div id="section3" class="space-y-4"></div>
          </div>
          <div id="quiz-part4" class="part-section hidden">
            <div id="section4" class="space-y-4"></div>
          </div>
          <div id="quiz-part5" class="part-section hidden">
            <div id="section5" class="space-y-4"></div>
          </div>
          <div id="quiz-part6" class="part-section hidden">
            <div id="section6" class="space-y-4"></div>
          </div>
          <div id="quiz-part7" class="part-section hidden">
            <div id="section7" class="space-y-4"></div>
          </div>
          <div class="flex space-x-4 sticky bottom-0 bg-white p-4">
            <button type="button" onclick="prevQuizPart(currentQuizPart + 1)" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Phần trước</button>
            <button type="button" onclick="nextQuizPart(currentQuizPart + 1)" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Phần tiếp theo</button>
            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Nộp bài</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Màn hình kết quả -->
  <div id="result-screen" class="container mx-auto p-4 hidden">
    <h1 class="text-3xl font-bold mb-4">Kết quả</h1>
    <p id="notification" class="text-red-500 mb-4"></p>
    <p id="result-score" class="text-lg mb-4"></p>
    <p id="result-time" class="text-lg mb-4"></p>
    <p id="download-notice" class="text-lg mb-4"></p>
    <button onclick="showWelcomeScreen()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Quay lại</button>
  </div>

  <script>
    // Đảm bảo handleCredentialResponse được định nghĩa sớm và trong phạm vi toàn cục
    window.handleCredentialResponse = function(response) {
      try {
        const data = JSON.parse(atob(response.credential.split('.')[1]));
        user = { email: data.email, name: data.name };
        isAdmin = data.email === "admin@example.com"; // Thay bằng email admin thực tế
        notification.innerText = "";
        if (isAdmin) {
          showAdminOptions();
        } else {
          showQuizList();
        }
      } catch (error) {
        console.error('Lỗi khi xử lý Google Sign-In:', error);
        notification.innerText = 'Lỗi đăng nhập Google. Vui lòng thử lại.';
      }
    };

    // Biến toàn cục
    let user = null;
    let isAdmin = false;
    let timeLeft = 7200;
    let timerInterval = null;
    let isAdminControlled = false;
    let selectedQuizId = null;
    let isDirectTestMode = false;
    let isTestEnded = false;
    const welcomeScreen = document.getElementById("welcome-screen");
    const adminLogin = document.getElementById("admin-login");
    const studentLogin = document.getElementById("student-login");
    const studentNameForm = document.getElementById("student-name-form");
    const quizListScreen = document.getElementById("quiz-list-screen");
    const adminOptions = document.getElementById("admin-options");
    const adminControls = document.getElementById("admin-controls");
    const uploadQuizzesSection = document.getElementById("upload-quizzes");
    const historyScreen = document.getElementById("history-screen");
    const quizList = document.getElementById("quiz-list");
    const quizContainer = document.getElementById("quiz-container");
    const notification = document.getElementById("notification");
    const quizStatus = document.getElementById("quiz-status");
    const participantCount = document.getElementById("participant-count");
    const submittedCount = document.getElementById("submitted-count");
    const assignBtn = document.getElementById("assignBtn");
    const directTestBtn = document.getElementById("directTestBtn");
    const directTestScreen = document.getElementById("direct-test-screen");
    const endDirectTestBtn = document.getElementById("endDirectTestBtn");
    const directParticipantCount = document.getElementById("direct-participant-count");
    const directSubmittedCount = document.getElementById("direct-submitted-count");
    const directResultsTable = document.getElementById("direct-results-table");
    const directResultsBody = document.getElementById("direct-results-body");
    const resultsTable = document.getElementById("results-table");
    const resultsBody = document.getElementById("results-body");
    const historyBody = document.getElementById("history-body");
    const imageList = document.getElementById("image-list");
    const imageContent = document.getElementById("image-content");
    const imagePartNumber = document.getElementById("image-part-number");
    const questionList = document.getElementById("question-list");
    const questionPartNumber = document.getElementById("question-part-number");
    const audio = document.getElementById("audio");
    const audioSource = document.getElementById("audio-source");
    const timerDisplay = document.getElementById("timer");
    const quizForm = document.getElementById("quizForm");
    const resultScreen = document.getElementById("result-screen");
    const resultScore = document.getElementById("result-score");
    const resultTime = document.getElementById("result-time");
    const downloadNotice = document.getElementById("download-notice");
    const wsProtocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
    let socket = null;
    let currentAdminStep = 0;
    let currentQuizPart = 0;
    const partAnswerCounts = [6, 25, 39, 30, 30, 16, 54];

    // Hàm hiển thị số đáp án đã nhập
    function displayAnswerCount(part) {
      const input = document.getElementById(`answer-key-part${part}`).value.trim();
      const answers = input
        .replace(/\s+/g, '')
        .split(',')
        .filter(a => a !== '');
      const expectedCount = partAnswerCounts[part - 1];
      const countElement = document.getElementById(`answer-count-part${part}`);
      countElement.innerText = `Đã nhập: ${answers.length}/${expectedCount} đáp án`;
      if (answers.length > expectedCount) {
        countElement.classList.add('text-red-500');
      } else {
        countElement.classList.remove('text-red-500');
      }
    }

    // Hàm lưu đề thi
    async function saveQuiz() {
      // Kiểm tra tên đề thi
      const quizName = document.getElementById("quiz-name").value.trim();
      if (!quizName) {
        notification.innerText = "Vui lòng nhập tên đề thi!";
        return;
      }
      if (quizName.length > 100) {
        notification.innerText = "Tên đề thi không được dài quá 100 ký tự!";
        return;
      }

      // Kiểm tra thông tin người dùng
      if (!user || !user.email) {
        notification.innerText = "Lỗi: Không tìm thấy thông tin người dùng. Vui lòng đăng nhập lại.";
        showAdminLogin();
        return;
      }

      // Khởi tạo FormData
      const formData = new FormData();

      // Xử lý file audio
      const audioInputs = [
        { id: "audio-file-part1", part: 1 },
        { id: "audio-file-part2", part: 2 },
        { id: "audio-file-part3", part: 3 },
        { id: "audio-file-part4", part: 4 },
      ];
      for (const { id, part } of audioInputs) {
        const audioFile = document.getElementById(id).files[0];
        if (!audioFile) {
          notification.innerText = `Vui lòng tải file nghe cho Part ${part}!`;
          return;
        }
        if (!audioFile.type.startsWith("audio/")) {
          notification.innerText = `File nghe Part ${part} phải là định dạng audio (mp3, wav, v.v.)!`;
          return;
        }
        if (audioFile.size > 50 * 1024 * 1024) {
          notification.innerText = `File nghe Part ${part} không được lớn hơn 50MB!`;
          return;
        }
        formData.append(`audio-part${part}`, audioFile);
        console.log(`Đã thêm file audio Part ${part}: ${audioFile.name}, kích thước: ${(audioFile.size / 1024 / 1024).toFixed(2)} MB`);
      }

      // Xử lý ảnh
      for (let part = 1; part <= 7; part++) {
        const imageInput = document.getElementById(`images-part${part}`);
        const files = imageInput.files;
        if (files.length === 0) {
          notification.innerText = `Vui lòng tải ít nhất một ảnh cho Part ${part}!`;
          return;
        }
        for (const file of files) {
          if (!file.type.startsWith("image/")) {
            notification.innerText = `File ảnh Part ${part} phải là định dạng ảnh (jpg, png, v.v.)!`;
            return;
          }
          if (file.size > 10 * 1024 * 1024) {
            notification.innerText = `File ảnh Part ${part} không được lớn hơn 10MB!`;
            return;
          }
          formData.append(`images-part${part}`, file);
          console.log(`Đã thêm file ảnh Part ${part}: ${file.name}, kích thước: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
        }
      }

      // Xử lý đáp án
      const answerKey = {};
      let questionIndex = 1;
      for (let part = 1; part <= 7; part++) {
        const answerKeyInput = document.getElementById(`answer-key-part${part}`).value.trim();
        if (!answerKeyInput) {
          notification.innerText = `Vui lòng nhập đáp án cho Part ${part}!`;
          return;
        }
        const answers = answerKeyInput
          .replace(/\s+/g, '')
          .split(',')
          .map(a => a.trim().toUpperCase())
          .filter(a => a !== '');
        const expectedCount = partAnswerCounts[part - 1];
        if (answers.length !== expectedCount) {
          notification.innerText = `Part ${part} phải có đúng ${expectedCount} đáp án, hiện có ${answers.length}!`;
          return;
        }
        for (let i = 0; i < answers.length; i++) {
          if (!['A', 'B', 'C', 'D'].includes(answers[i])) {
            notification.innerText = `Đáp án Part ${part} phải là A, B, C hoặc D (câu ${i + 1}: ${answers[i]})!`;
            return;
          }
          answerKey[`q${questionIndex}`] = answers[i];
          questionIndex++;
        }
        console.log(`Đáp án Part ${part} (${answers.length}): [${answers.join(', ')}]`);
      }

      // Thêm metadata
      formData.append("quizName", quizName);
      formData.append("answerKey", JSON.stringify(answerKey));
      formData.append("createdBy", user.email);
      console.log("Metadata:", {
        quizName,
        createdBy: user.email,
        totalAnswers: Object.keys(answerKey).length
      });

      // Gửi yêu cầu
      try {
        console.log("Gửi yêu cầu lưu đề thi đến /save-quiz...");
        const res = await fetchWithRetry("/save-quiz", {
          method: "POST",
          body: formData,
        });
        const result = await res.json();
        if (res.ok) {
          notification.innerText = result.message || "Lưu đề thi thành công!";
          console.log("Lưu đề thi thành công:", result);
          backToQuizList();
        } else {
          throw new Error(result.message || `Lỗi server: ${res.status}`);
        }
      } catch (error) {
        console.error("Lỗi khi lưu đề thi:", error);
        notification.innerText = `Lỗi khi lưu đề thi: ${error.message}. Vui lòng kiểm tra dữ liệu và thử lại.`;
      }
    }

    // Các hàm điều khiển giao diện
    function showWelcomeScreen() {
      welcomeScreen.classList.remove("hidden");
      adminLogin.classList.add("hidden");
      studentLogin.classList.add("hidden");
      quizListScreen.classList.add("hidden");
      adminOptions.classList.add("hidden");
      adminControls.classList.add("hidden");
      uploadQuizzesSection.classList.add("hidden");
      historyScreen.classList.add("hidden");
      directTestScreen.classList.add("hidden");
      quizContainer.classList.add("hidden");
      resultScreen.classList.add("hidden");
      document.querySelectorAll(".admin-step").forEach(step => step.classList.add("hidden"));
      notification.innerText = "";
    }

    function showAdminLogin() {
      welcomeScreen.classList.add("hidden");
      adminLogin.classList.remove("hidden");
      studentLogin.classList.add("hidden");
      notification.innerText = "";
    }

    function showStudentLogin() {
      welcomeScreen.classList.add("hidden");
      adminLogin.classList.add("hidden");
      studentLogin.classList.remove("hidden");
      notification.innerText = "";
    }

    function showAdminOptions() {
      adminLogin.classList.add("hidden");
      adminOptions.classList.remove("hidden");
      notification.innerText = "";
    }

    function showQuizList() {
      quizListScreen.classList.remove("hidden");
      adminOptions.classList.add("hidden");
      adminControls.classList.add("hidden");
      uploadQuizzesSection.classList.add("hidden");
      historyScreen.classList.add("hidden");
      directTestScreen.classList.add("hidden");
      notification.innerText = "";
      fetchQuizzes();
    }

    function showUploadQuizzes() {
      uploadQuizzesSection.classList.remove("hidden");
      adminOptions.classList.add("hidden");
      notification.innerText = "";
    }

    function showHistory() {
      historyScreen.classList.remove("hidden");
      adminOptions.classList.add("hidden");
      notification.innerText = "";
      fetchHistory();
    }

    function showDirectTestScreen() {
      directTestScreen.classList.remove("hidden");
      adminOptions.classList.add("hidden");
      notification.innerText = "";
    }

    function showAdminStep(step) {
      currentAdminStep = step;
      document.querySelectorAll(".admin-step").forEach(s => s.classList.add("hidden"));
      document.getElementById(`admin-step-${step === 1 ? 'audio' : `part${step - 1}`}`).classList.remove("hidden");
      uploadQuizzesSection.classList.add("hidden");
      notification.innerText = "";
    }

    function nextAdminStep(currentStep) {
      if (currentStep === 1) {
        const quizName = document.getElementById("quiz-name").value.trim();
        if (!quizName) {
          notification.innerText = "Vui lòng nhập tên đề thi!";
          return;
        }
        for (let i = 1; i <= 4; i++) {
          const audioFile = document.getElementById(`audio-file-part${i}`).files[0];
          if (!audioFile) {
            notification.innerText = `Vui lòng tải file nghe cho Part ${i}!`;
            return;
          }
        }
      } else {
        const part = currentStep - 1;
        const images = document.getElementById(`images-part${part}`).files;
        const answers = document.getElementById(`answer-key-part${part}`).value.trim();
        if (images.length === 0) {
          notification.innerText = `Vui lòng tải ít nhất một ảnh cho Part ${part}!`;
          return;
        }
        if (!answers) {
          notification.innerText = `Vui lòng nhập đáp án cho Part ${part}!`;
          return;
        }
      }
      showAdminStep(currentStep + 1);
    }

    function prevAdminStep(currentStep) {
      showAdminStep(currentStep - 1);
    }

    function backToQuizList() {
      showQuizList();
      document.querySelectorAll(".admin-step").forEach(step => step.classList.add("hidden"));
      currentAdminStep = 0;
    }

    // Hàm lấy danh sách đề thi
    async function fetchQuizzes() {
      try {
        const res = await fetchWithRetry("/get-quizzes");
        const quizzes = await res.json();
        quizList.innerHTML = "";
        quizzes.forEach(quiz => {
          const div = document.createElement("div");
          div.className = "bg-white p-4 rounded-lg shadow";
          div.innerHTML = `
            <h3 class="text-lg font-semibold">${quiz.quizName}</h3>
            <button onclick="selectQuiz('${quiz._id}')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">
              ${isAdmin ? 'Quản lý' : 'Làm bài'}
            </button>
          `;
          quizList.appendChild(div);
        });
      } catch (error) {
        notification.innerText = "Lỗi khi lấy danh sách đề thi: " + error.message;
      }
    }

    // Hàm chọn đề thi
    function selectQuiz(quizId) {
      selectedQuizId = quizId;
      if (isAdmin) {
        adminControls.classList.remove("hidden");
        quizListScreen.classList.add("hidden");
        fetchQuizStatus();
      } else {
        startQuiz();
      }
    }

    // Hàm lấy trạng thái đề thi
    async function fetchQuizStatus() {
      try {
        const res = await fetchWithRetry(`/quiz-status/${selectedQuizId}`);
        const status = await res.json();
        quizStatus.innerText = `Trạng thái: ${status.status}`;
        participantCount.innerText = `Số người tham gia: ${status.participants}`;
        submittedCount.innerText = `Số bài đã nộp: ${status.submitted}`;
        resultsBody.innerHTML = "";
        status.results.forEach(result => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border p-2">${result.studentName}</td>
            <td class="border p-2">${result.score}</td>
            <td class="border p-2">${result.time}</td>
          `;
          resultsBody.appendChild(tr);
        });
      } catch (error) {
        notification.innerText = "Lỗi khi lấy trạng thái đề thi: " + error.message;
      }
    }

    // Hàm bắt đầu thi
    function startQuiz() {
      quizContainer.classList.remove("hidden");
      quizListScreen.classList.add("hidden");
      timerDisplay.classList.remove("hidden");
      audio.classList.remove("hidden");
      currentQuizPart = 1;
      loadQuiz();
      startTimer();
      connectWebSocket();
    }

    // Hàm tải nội dung đề thi
    async function loadQuiz() {
      try {
        const res = await fetchWithRetry(`/get-quiz/${selectedQuizId}`);
        const quiz = await res.json();
        loadImages(quiz.imageFiles);
        loadAudio(quiz.audioFiles);
        createQuestions();
      } catch (error) {
        notification.innerText = "Lỗi khi tải đề thi: " + error.message;
      }
    }

    // Hàm tải ảnh
    function loadImages(imageFiles) {
      imageContent.innerHTML = "";
      const partImages = imageFiles.filter(file => file.part === currentQuizPart);
      partImages.forEach(file => {
        const img = document.createElement("img");
        img.src = file.path;
        img.className = "w-full rounded";
        imageContent.appendChild(img);
      });
      imagePartNumber.innerText = currentQuizPart;
    }

    // Hàm tải audio
    function loadAudio(audioFiles) {
      const partAudio = audioFiles.find(file => file.part === currentQuizPart);
      if (partAudio) {
        audioSource.src = partAudio.path;
        audio.load();
      } else {
        audioSource.src = "";
        audio.load();
      }
    }

    // Hàm tạo câu hỏi
    function createQuestions() {
      const sections = [6, 25, 39, 30, 30, 16, 54];
      let startIndex = 1;
      for (let i = 1; i < currentQuizPart; i++) {
        startIndex += sections[i - 1];
      }
      const section = document.getElementById(`section${currentQuizPart}`);
      section.innerHTML = "";
      for (let i = 0; i < sections[currentQuizPart - 1]; i++) {
        const questionDiv = document.createElement("div");
        questionDiv.className = "space-y-2";
        questionDiv.innerHTML = `
          <p class="font-semibold">Câu ${startIndex + i}:</p>
          <div class="flex space-x-4">
            <label><input type="radio" name="q${startIndex + i}" value="A"> A</label>
            <label><input type="radio" name="q${startIndex + i}" value="B"> B</label>
            <label><input type="radio" name="q${startIndex + i}" value="C"> C</label>
            <label><input type="radio" name="q${startIndex + i}" value="D"> D</label>
          </div>
        `;
        section.appendChild(questionDiv);
      }
      questionPartNumber.innerText = currentQuizPart;
      document.querySelectorAll(".part-section").forEach(s => s.classList.add("hidden"));
      document.getElementById(`quiz-part${currentQuizPart}`).classList.remove("hidden");
    }

    // Hàm chuyển phần
    function nextQuizPart(part) {
      if (part <= 7) {
        currentQuizPart = part;
        loadQuiz();
      }
    }

    function prevQuizPart(part) {
      if (part > 1) {
        currentQuizPart = part - 2;
        loadQuiz();
      }
    }

    // Hàm bắt đầu đếm giờ
    function startTimer() {
      timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          submitQuiz();
          return;
        }
        const hours = Math.floor(timeLeft / 3600);
        const minutes = Math.floor((timeLeft % 3600) / 60);
        const seconds = timeLeft % 60;
        timerDisplay.innerText = `Thời gian còn lại: ${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timeLeft--;
      }, 1000);
    }

    // Hàm nộp bài
    async function submitQuiz() {
      clearInterval(timerInterval);
      const formData = new FormData(quizForm);
      const answers = {};
      for (let [key, value] of formData.entries()) {
        answers[key] = value;
      }
      try {
        const res = await fetchWithRetry("/submit-quiz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            quizId: selectedQuizId,
            studentName: user.name,
            answers,
            time: 7200 - timeLeft,
          }),
        });
        const result = await res.json();
        if (res.ok) {
          resultScore.innerText = `Điểm: ${result.score}`;
          resultTime.innerText = `Thời gian: ${Math.floor(result.time / 60)} phút ${result.time % 60} giây`;
          quizContainer.classList.add("hidden");
          resultScreen.classList.remove("hidden");
          socket.send(JSON.stringify({ type: "submit", quizId: selectedQuizId, studentName: user.name, score: result.score, time: result.time }));
        } else {
          notification.innerText = result.message || "Lỗi khi nộp bài!";
        }
      } catch (error) {
        notification.innerText = "Lỗi khi nộp bài: " + error.message;
      }
    }

    // Hàm lấy lịch sử thi
    async function fetchHistory() {
      try {
        const res = await fetchWithRetry("/history");
        const history = await res.json();
        historyBody.innerHTML = "";
        history.forEach(record => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border p-2">${record.quizName}</td>
            <td class="border p-2">${record.studentName}</td>
            <td class="border p-2">${record.score}</td>
            <td class="border p-2">${Math.floor(record.time / 60)} phút ${record.time % 60} giây</td>
          `;
          historyBody.appendChild(tr);
        });
      } catch (error) {
        notification.innerText = "Lỗi khi lấy lịch sử thi: " + error.message;
      }
    }

    // Hàm kết nối WebSocket
    function connectWebSocket() {
      socket = new WebSocket(`${wsProtocol}${location.host}:8080`);
      socket.onopen = () => {
        console.log("WebSocket connected");
        socket.send(JSON.stringify({ type: "join", quizId: selectedQuizId, studentName: user.name }));
      };
      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === "start" && !isAdmin) {
            startQuiz();
          } else if (data.type === "end" && !isAdmin) {
            submitQuiz();
          } else if (data.type === "update") {
            participantCount.innerText = `Số người tham gia: ${data.participants}`;
            submittedCount.innerText = `Số bài đã nộp: ${data.submitted}`;
            directParticipantCount.innerText = `Số người tham gia: ${data.participants}`;
            directSubmittedCount.innerText = `Số bài đã nộp: ${data.submitted}`;
            const tbody = isDirectTestMode ? directResultsBody : resultsBody;
            tbody.innerHTML = "";
            data.results.forEach(result => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td class="border p-2">${result.studentName}</td>
                <td class="border p-2">${result.score}</td>
                <td class="border p-2">${result.time}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        } catch (error) {
          console.error('Lỗi khi xử lý WebSocket message:', error);
        }
      };
      socket.onclose = () => {
        console.log("WebSocket disconnected");
      };
    }

    // Hàm fetch với retry
    async function fetchWithRetry(url, options = {}, retries = 5, delay = 2000) {
      for (let i = 0; i < retries; i++) {
        try {
          const res = await fetch(url, options);
          if (res.ok) return res;
          throw new Error(`HTTP error! Status: ${res.status}`);
        } catch (error) {
          console.error(`Lần thử ${i + 1} thất bại:`, error);
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // Sự kiện submit form học sinh
    studentNameForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const studentName = document.getElementById("student-name").value.trim();
      if (!studentName) {
        notification.innerText = "Vui lòng nhập tên học sinh!";
        return;
      }
      user = { name: studentName };
      showQuizList();
    });

    // Sự kiện bắt đầu thi trực tiếp
    directTestBtn.addEventListener("click", () => {
      isDirectTestMode = true;
      socket.send(JSON.stringify({ type: "start", quizId: selectedQuizId }));
      directTestBtn.classList.add("hidden");
      endDirectTestBtn.classList.remove("hidden");
    });

    // Sự kiện kết thúc thi trực tiếp
    endDirectTestBtn.addEventListener("click", () => {
      socket.send(JSON.stringify({ type: "end", quizId: selectedQuizId }));
      isDirectTestMode = false;
      directTestBtn.classList.remove("hidden");
      endDirectTestBtn.classList.add("hidden");
    });

    // Sự kiện nộp bài
    quizForm.addEventListener("submit", (e) => {
      e.preventDefault();
      submitQuiz();
    });
  </script>
</body>
</html>